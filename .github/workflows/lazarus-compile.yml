on:
  push:
    branches:
      - master
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.operating-system }}
    strategy:
      matrix:
        operating-system: [windows-latest, ubuntu-latest, macos-latest]
        lazarus-versions: [stable]
    
    steps:
    - name: Checkout Source Code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set Version Environment Variable
      shell: bash
      run: |
        # If triggered by a tag, use the tag name. Otherwise, use 'latest'
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          echo "REL_VER=${{ github.ref_name }}" >> $GITHUB_ENV
        else
          echo "REL_VER=latest" >> $GITHUB_ENV
        fi

    - name: Install Lazarus
      uses: gcarreno/setup-lazarus@v3.4.1
      with:
        lazarus-version: ${{ matrix.lazarus-versions }}
        with-cache: false

    - name: Build the Windows Application
      if: ${{ matrix.operating-system == 'windows-latest' }}
      run: lazbuild -B src/bgrabitmap/bgrabitmap/bgrabitmappack.lpk; lazbuild -B src/metadarkstyle/metadarkstyle.lpk; lazbuild -B src/Cantara.lpi

    - name: Install libqt6pas (Ubuntu)
      if: ${{ matrix.operating-system == 'ubuntu-latest' }}
      run: |
        wget https://github.com/davidbannon/libqt6pas/releases/download/v6.2.7/libqt6pas6-dev_6.2.7-1_amd64.deb
        wget https://github.com/davidbannon/libqt6pas/releases/download/v6.2.7/libqt6pas6_6.2.7-1_amd64.deb
        sudo apt install ./libqt6pas6_6.2.7-1_amd64.deb ./libqt6pas6-dev_6.2.7-1_amd64.deb

    - name: Build the Linux Application
      if: ${{ matrix.operating-system == 'ubuntu-latest' }}
      run: make

    - name: Build the MacOS Application
      if: ${{ matrix.operating-system == 'macos-latest' }}
      run: lazbuild -B src/bgrabitmap/bgrabitmap/bgrabitmappack.lpk && lazbuild -B src/metadarkstyle/metadarkstyle.lpk && lazbuild -B src/Cantara.lpi

    # --- PACKAGING WITH DYNAMIC NAMES ---

    - name: Zip Linux Binaries
      if: ${{ matrix.operating-system == 'ubuntu-latest' }}
      run: zip -r cantara-${{ env.REL_VER }}-linux-x64.zip cantara src/languages src/Cantara.ico app.cantara.Cantara.desktop app.cantara.Cantara.png COPYING

    - name: Create DEB/RPM Packages
      if: ${{ matrix.operating-system == 'ubuntu-latest' }}
      run: |
        sudo apt-get install ruby ruby-dev rubygems build-essential && sudo gem install --no-document fpm
        mkdir -p pkg/usr/local/bin
        cp cantara pkg/usr/local/bin
        # Use the tag name for fpm versioning
        CLEAN_VER=$(echo ${{ env.REL_VER }} | sed 's/v//g')
        fpm -s dir -t deb -n cantara -v $CLEAN_VER -C pkg .
        fpm -s dir -t rpm -n cantara -v $CLEAN_VER -C pkg .

    - name: Zip Windows Binaries
      if: ${{ matrix.operating-system == 'windows-latest' }}
      run: 7z a cantara-${{ env.REL_VER }}-windows-x64.zip ./src/cantara.exe ./src/languages ./src/Cantara.ico ./app.cantara.Cantara.desktop ./app.cantara.Cantara.png ./COPYING

    - name: Create Windows Installer (InnoSetup)
      if: ${{ matrix.operating-system == 'windows-latest' }}
      uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
      with:
        path: cantara.iss

    - name: Zip MacOS Application
      if: ${{ matrix.operating-system == 'macos-latest' }}
      run: zip -r cantara-${{ env.REL_VER }}-macos-x64.zip src/cantara.app COPYING

    # --- RELEASE UPLOAD ---

    - name: Upload to GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          cantara-${{ env.REL_VER }}-linux-x64.zip
          cantara*.deb
          cantara*.rpm
          cantara-${{ env.REL_VER }}-windows-x64.zip
          Output/cantara*.exe
          cantara-${{ env.REL_VER }}-macos-x64.zip